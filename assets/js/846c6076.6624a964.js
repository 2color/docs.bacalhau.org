"use strict";(self.webpackChunkbacalhau_docs=self.webpackChunkbacalhau_docs||[]).push([[1410],{3905:(e,t,a)=>{a.d(t,{Zo:()=>d,kt:()=>c});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function o(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?o(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):o(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},o=Object.keys(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(n=0;n<o.length;n++)a=o[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var s=n.createContext({}),p=function(e){var t=n.useContext(s),a=t;return e&&(a="function"==typeof e?e(t):l(l({},t),e)),a},d=function(e){var t=p(e.components);return n.createElement(s.Provider,{value:t},e.children)},u={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},m=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,o=e.originalType,s=e.parentName,d=i(e,["components","mdxType","originalType","parentName"]),m=p(a),c=r,h=m["".concat(s,".").concat(c)]||m[c]||u[c]||o;return a?n.createElement(h,l(l({ref:t},d),{},{components:a})):n.createElement(h,l({ref:t},d))}));function c(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=a.length,l=new Array(o);l[0]=m;var i={};for(var s in t)hasOwnProperty.call(t,s)&&(i[s]=t[s]);i.originalType=e,i.mdxType="string"==typeof e?e:r,l[1]=i;for(var p=2;p<o;p++)l[p]=a[p];return n.createElement.apply(null,l)}return n.createElement.apply(null,a)}m.displayName="MDXCreateElement"},3635:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>s,contentTitle:()=>l,default:()=>u,frontMatter:()=>o,metadata:()=>i,toc:()=>p});var n=a(3117),r=(a(7294),a(3905));const o={sidebar_label:"Simple Parallel Workloads",sidebar_position:2},l="Parallel Video Resizing via File Sharding",i={unversionedId:"examples/data-engineering/simple-parallel-workloads/index",id:"examples/data-engineering/simple-parallel-workloads/index",title:"Parallel Video Resizing via File Sharding",description:"Open In Colab",source:"@site/docs/examples/data-engineering/simple-parallel-workloads/index.md",sourceDirName:"examples/data-engineering/simple-parallel-workloads",slug:"/examples/data-engineering/simple-parallel-workloads/",permalink:"/examples/data-engineering/simple-parallel-workloads/",draft:!1,editUrl:"https://github.com/bacalhau-project/docs.bacalhau.org/blob/main/docs/examples/data-engineering/simple-parallel-workloads/index.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_label:"Simple Parallel Workloads",sidebar_position:2},sidebar:"documentationSidebar",previous:{title:"Simple Image Processing",permalink:"/examples/data-engineering/image-processing/"},next:{title:"Oceanography - Data Conversion",permalink:"/examples/data-engineering/oceanography-conversion/"}},s={},p=[{value:"Submit the workload",id:"submit-the-workload",level:2},{value:"A Simple Video Resize Example",id:"a-simple-video-resize-example",level:3},{value:"Get Results",id:"get-results",level:2}],d={toc:p};function u(e){let{components:t,...o}=e;return(0,r.kt)("wrapper",(0,n.Z)({},d,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("h1",{id:"parallel-video-resizing-via-file-sharding"},"Parallel Video Resizing via File Sharding"),(0,r.kt)("p",null,(0,r.kt)("a",{parentName:"p",href:"https://colab.research.google.com/github/bacalhau-project/examples/blob/main/data-engineering/simple-parallel-workloads/index.ipynb"},(0,r.kt)("img",{parentName:"a",src:"https://colab.research.google.com/assets/colab-badge.svg",alt:"Open In Colab"})),"\n",(0,r.kt)("a",{parentName:"p",href:"https://mybinder.org/v2/gh/bacalhau-project/examples/HEAD?labpath=data-engineering%2Fsimple-parallel-workloads%2Findex.ipynb"},(0,r.kt)("img",{parentName:"a",src:"https://mybinder.org/badge.svg",alt:"Open In Binder"}))),(0,r.kt)("p",null,"Many data engineering workloads consist of embarrassingly parallel workloads where you want to run a simple execution on a large number of files. In this notebook, we will use the ",(0,r.kt)("a",{parentName:"p",href:"https://docs.bacalhau.org/getting-started/parallel-workloads"},"Sharding")," functionality in Bacalhau to run a simple video filter on a large number of video files."),(0,r.kt)("blockquote",null,(0,r.kt)("p",{parentName:"blockquote"},"Although you would normally you would use your own container and script to make your workloads reproducible, in this example we will use a pre-built container and CLI arguments to allow you to make changes. You can find the container ",(0,r.kt)("a",{parentName:"p",href:"https://hub.docker.com/r/linuxserver/ffmpeg"},"on docker hub"),".")),(0,r.kt)("h2",{id:"submit-the-workload"},"Submit the workload"),(0,r.kt)("p",null,"To submit a workload to Bacalhau you can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"bacalhau docker run")," command. This allows you to pass input data volume with a ",(0,r.kt)("inlineCode",{parentName:"p"},"-v CID:path")," argument just like Docker, except the left-hand side of the argument is a ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/multiformats/cid"},"content identifier (CID)"),". This results in Bacalhau mounting a ",(0,r.kt)("em",{parentName:"p"},"data volume")," inside the container. By default, Bacalhau mounts the input volume at the path ",(0,r.kt)("inlineCode",{parentName:"p"},"/inputs")," inside the container."),(0,r.kt)("p",null,"Bacalhau also mounts a data volume to store output data. By default ",(0,r.kt)("inlineCode",{parentName:"p"},"bacalhau docker run")," creates an output data volume mounted at ",(0,r.kt)("inlineCode",{parentName:"p"},"/outputs"),". This is a convenient location to store the results of your job. See below for an example."),(0,r.kt)("p",null,"And to shard across files in the input directory, we need to pass three (optional) arguments to the command:"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sharding-base-path")," - the path to the directory you want to shard over"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sharding-glob-pattern")," - the pattern to match files in the directory"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"sharding-batch-size")," - the number of files to pass into each job")),(0,r.kt)("h3",{id:"a-simple-video-resize-example"},"A Simple Video Resize Example"),(0,r.kt)("p",null,"In this example, you will create 72px wide video thumbnails for all the videos in the ",(0,r.kt)("inlineCode",{parentName:"p"},"inputs")," directory. The ",(0,r.kt)("inlineCode",{parentName:"p"},"outputs")," directory will contain the thumbnails for each video. We will shard by 1 video per job, and use the ",(0,r.kt)("inlineCode",{parentName:"p"},"linuxserver/ffmpeg")," container to resize the videos."),(0,r.kt)("p",null,"Note that ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/filecoin-project/bacalhau/blob/v0.2.3/cmd/bacalhau/docker_run.go#L64"},"Bacalhau overwrites the default entrypoint")," so we must run the full command after the ",(0,r.kt)("inlineCode",{parentName:"p"},"--")," argument. In this line you will list all of the mp4 files in the ",(0,r.kt)("inlineCode",{parentName:"p"},"/inputs")," directory and execute ",(0,r.kt)("inlineCode",{parentName:"p"},"ffmpeg")," against each instance."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'bacalhau docker run \\\n  --wait \\\n  --wait-timeout-secs 100 \\\n  --sharding-base-path "/inputs" \\\n  --sharding-glob-pattern "*.mp4" \\\n  --sharding-batch-size 1 \\\n  -v Qmd9CBYpdgCLuCKRtKRRggu24H72ZUrGax5A9EYvrbC72j:/inputs \\\n  linuxserver/ffmpeg -- \\\n  bash -c \'find /inputs -iname "*.mp4" -printf "%f\\n" | xargs -I{} ffmpeg -y -i /inputs/{} -vf "scale=-1:72,setsar=1:1" /outputs/scaled_{}\'\n\n')),(0,r.kt)("h2",{id:"get-results"},"Get Results"),(0,r.kt)("p",null,"Now let's download and display the result from the results directory. We can use the ",(0,r.kt)("inlineCode",{parentName:"p"},"bacalhau results")," command to download the results from the output data volume. The ",(0,r.kt)("inlineCode",{parentName:"p"},"--output-dir")," argument specifies the directory to download the results to."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"mkdir -p ./results # Temporary directory to store the results\nbacalhau get --output-dir ./results ${JOB_ID} # Download the results\n")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre"},"\x1b[90m09:34:30.583 |\x1b[0m \x1b[32mINF\x1b[0m \x1b[1mbacalhau/get.go:67\x1b[0m\x1b[36m >\x1b[0m Fetching results of job '7b2b3b0c-18cc-479f-9bff-48b7569b7389'...\n\x1b[90m09:34:36.542 |\x1b[0m \x1b[32mINF\x1b[0m \x1b[1mipfs/downloader.go:115\x1b[0m\x1b[36m >\x1b[0m Found 3 result shards, downloading to temporary folder.\n\x1b[90m09:34:40.188 |\x1b[0m \x1b[32mINF\x1b[0m \x1b[1mipfs/downloader.go:195\x1b[0m\x1b[36m >\x1b[0m Combining shard from output volume 'outputs' to final location: '/Users/phil/source/bacalhau-project/examples/data-engineering/simple-parallel-workloads/results'\n\x1b[90m09:34:41.745 |\x1b[0m \x1b[32mINF\x1b[0m \x1b[1mipfs/downloader.go:195\x1b[0m\x1b[36m >\x1b[0m Combining shard from output volume 'outputs' to final location: '/Users/phil/source/bacalhau-project/examples/data-engineering/simple-parallel-workloads/results'\n\x1b[90m09:34:43.477 |\x1b[0m \x1b[32mINF\x1b[0m \x1b[1mipfs/downloader.go:195\x1b[0m\x1b[36m >\x1b[0m Combining shard from output volume 'outputs' to final location: '/Users/phil/source/bacalhau-project/examples/data-engineering/simple-parallel-workloads/results'\n")),(0,r.kt)("video",{src:a(4388).Z,controls:!0},"Your browser does not support the ",(0,r.kt)("code",null,"video")," element."),(0,r.kt)("video",{src:a(2601).Z,controls:!0},"Your browser does not support the ",(0,r.kt)("code",null,"video")," element."),(0,r.kt)("video",{src:a(934).Z,controls:!0},"Your browser does not support the ",(0,r.kt)("code",null,"video")," element."))}u.isMDXComponent=!0},4388:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/medias/scaled_Bird_flying_over_the_lake-a35ded07d76907c969d61443c1df69ea.mp4"},2601:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/medias/scaled_Calm_waves_on_a_rocky_sea_gulf-4b87ad9600fcd7312ca0d6d698f6ee54.mp4"},934:(e,t,a)=>{a.d(t,{Z:()=>n});const n=a.p+"assets/medias/scaled_Prominent_Late_Gothic_styled_architecture-ae80302d26c5b26fe679f3cf2bf33b2a.mp4"}}]);